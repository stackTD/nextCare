{% extends "base.html" %}

{% block title %}{{ machine.name }} - Dashboard{% endblock %}

{% block extra_head %}
<style>
    .parameter-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .parameter-card:hover {
        transform: translateY(-2px);
    }
    
    .parameter-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .parameter-unit {
        font-size: 1rem;
        color: #6c757d;
    }
    
    .status-good { color: #28a745; }
    .status-warning { color: #ffc107; }
    .status-danger { color: #dc3545; }
    
    .mini-chart {
        height: 100px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">{{ machine.name }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-cpu"></i> {{ machine.name }}</h2>
            <p class="text-muted">{{ machine.description }}</p>
        </div>
        <div>
            <button class="btn btn-outline-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    
    <!-- Machine Information -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><i class="bi bi-info-circle"></i> Machine Information</h6>
                    <p><strong>Location:</strong> {{ machine.location or 'Not specified' }}</p>
                    <p><strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if machine.is_active else 'secondary' }}">
                            {{ 'Active' if machine.is_active else 'Inactive' }}
                        </span>
                    </p>
                    <p><strong>Parameters:</strong> {{ parameters|length }}</p>
                    <p><strong>Last Update:</strong> <span id="lastUpdate">Loading...</span></p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h6><i class="bi bi-activity"></i> System Status</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 status-good" id="systemStatus">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <small>System Health</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4" id="dataQuality">95%</div>
                                <small>Data Quality</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4" id="alertCount">{{ parameters|length }}</div>
                                <small>Parameters Online</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Parameters Grid -->
    <div class="row">
        {% for parameter in parameters %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card parameter-card" onclick="viewParameterDetail({{ parameter.parameter_id }})">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ parameter.name }}</h6>
                    <span class="badge bg-info">{{ parameter.register_address }}</span>
                </div>
                <div class="card-body text-center">
                    <div id="param-{{ parameter.parameter_id }}-status" class="status-good">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="parameter-value" id="param-{{ parameter.parameter_id }}-value">
                        {% if parameter.latest_data %}
                        {{ "%.2f"|format(parameter.latest_data.value) }}
                        {% else %}
                        --
                        {% endif %}
                    </div>
                    <div class="parameter-unit">{{ parameter.unit }}</div>
                    
                    <!-- Range Information -->
                    <div class="mt-2">
                        <small class="text-muted">
                            Range: 
                            {{ parameter.min_value or '-' }} to 
                            {{ parameter.max_value or '-' }} {{ parameter.unit }}
                        </small>
                    </div>
                    
                    <!-- Mini chart -->
                    <div class="mini-chart">
                        <canvas id="chart-{{ parameter.parameter_id }}" width="300" height="100"></canvas>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <small class="text-muted" id="param-{{ parameter.parameter_id }}-timestamp">
                        {% if parameter.latest_data %}
                        {{ parameter.latest_data.timestamp }}
                        {% else %}
                        No data
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not parameters %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-list-ul" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No parameters configured</h4>
                <p class="text-muted">Configure parameters to start monitoring this machine</p>
                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('config.list_parameters', machine_id=machine.machine_id) }}" 
                   class="btn btn-primary">
                    <i class="bi bi-gear"></i> Configure Parameters
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let charts = {};
let refreshInterval;

function refreshData() {
    fetch(`/dashboard/api/machine/{{ machine.machine_id }}/live-data`)
        .then(response => response.json())
        .then(data => {
            updateParameterValues(data.parameters);
            document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString();
        })
        .catch(error => console.error('Error refreshing data:', error));
}

function updateParameterValues(parameters) {
    parameters.forEach(param => {
        const valueElement = document.getElementById(`param-${param.parameter_id}-value`);
        const statusElement = document.getElementById(`param-${param.parameter_id}-status`);
        const timestampElement = document.getElementById(`param-${param.parameter_id}-timestamp`);
        
        if (valueElement) {
            valueElement.textContent = param.value.toFixed(2);
        }
        
        if (timestampElement) {
            timestampElement.textContent = new Date(param.timestamp).toLocaleTimeString();
        }
        
        if (statusElement) {
            const status = getParameterStatus(param.value, param.min_value, param.max_value);
            statusElement.className = `status-${status.class}`;
            statusElement.innerHTML = `<i class="bi bi-${status.icon}"></i>`;
        }
        
        // Update mini chart
        updateMiniChart(param.parameter_id, param.value);
    });
}

function getParameterStatus(value, minValue, maxValue) {
    if (minValue !== null && value < minValue) {
        return { class: 'danger', icon: 'exclamation-triangle' };
    }
    if (maxValue !== null && value > maxValue) {
        return { class: 'danger', icon: 'exclamation-triangle' };
    }
    return { class: 'good', icon: 'check-circle' };
}

function initializeMiniCharts() {
    {% for parameter in parameters %}
    const ctx{{ parameter.parameter_id }} = document.getElementById('chart-{{ parameter.parameter_id }}').getContext('2d');
    charts[{{ parameter.parameter_id }}] = new Chart(ctx{{ parameter.parameter_id }}, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '{{ parameter.name }}',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    display: false,
                    {% if parameter.min_value and parameter.max_value %}
                    min: {{ parameter.min_value }},
                    max: {{ parameter.max_value }}
                    {% endif %}
                }
            },
            elements: {
                point: {
                    radius: 0
                }
            }
        }
    });
    {% endfor %}
}

function updateMiniChart(parameterId, value) {
    const chart = charts[parameterId];
    if (chart) {
        const now = new Date().toLocaleTimeString();
        
        // Keep only last 20 data points
        if (chart.data.labels.length >= 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
        }
        
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(value);
        chart.update('none');
    }
}

function viewParameterDetail(parameterId) {
    window.location.href = `/dashboard/parameter/${parameterId}`;
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMiniCharts();
    refreshData();
    refreshInterval = setInterval(refreshData, 10000); // Refresh every 10 seconds
});

// Clean up interval when leaving page
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}